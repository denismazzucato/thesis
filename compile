#!/bin/bash
set -e

# Output directory
OUTPUT=pdf
# PDF name (without extension)
PDF_NAME=thesis
# packages path
PACKAGES=settings/packages.tex
# PSL template directory
# PSL_TEMPLATE=psl

# Create the pdf directory if it doesn't exist
if [ ! -d "$OUTPUT" ]; then
  mkdir "$OUTPUT"
fi
# if [ ! -d "$PSL_TEMPLATE/$OUTPUT" ]; then
#   mkdir "$PSL_TEMPLATE/$OUTPUT"
# fi

# Clean the output directory
# rm -rf "$OUTPUT"/*
rm -rf pdf/*

## do thesis.tex

# Comment out \drafttrue for final compilation
# sed -i.bak 's/\\drafttrue/%\\drafttrue/g' "$PACKAGES"

pdflatex -interaction=nonstopmode --synctex=1 --output-directory=pdf -file-line-error thesis
echo "Finished first compilation"
# Compile nomenclature
makeindex pdf/thesis.nlo -s nomencl.ist -o pdf/thesis.nls
echo "Finished nomenclature"
# Compile index
makeindex pdf/thesis
echo "Finished index"
# Compile bibliography
biber pdf/thesis
echo "Finished bibliography"
pdflatex -interaction=nonstopmode --synctex=1 --output-directory=pdf -file-line-error thesis
echo "Finished second compilation"
# Compile glossary
cd pdf
makeglossaries thesis
echo "Finished glossary"
cd ..
pdflatex -interaction=nonstopmode --synctex=1 --output-directory=pdf -file-line-error thesis
echo "Finished third compilation"
pdflatex -interaction=nonstopmode --synctex=1 --output-directory=pdf -file-line-error thesis
echo "Finished fourth compilation"

# Uncomment \drafttrue for draft compilation
# sed -i.bak 's/%\\drafttrue/\\drafttrue/g' "$PACKAGES"

## do psl/thesis.tex

# cd "$PSL_TEMPLATE"
# pdflatex -interaction=nonstopmode --output-directory=pdf thesis
# pdflatex -interaction=nonstopmode --output-directory=pdf thesis
# pdflatex -interaction=nonstopmode --output-directory=pdf thesis
# cd ..

# merge the two
pdftk pdf/thesis.pdf cat 2-end output pdf/thesis-tail.pdf
pdftk psl-first.pdf pdf/thesis-tail.pdf cat output pdf/thesis-but-last.pdf
pdftk pdf/thesis-but-last.pdf psl-last.pdf cat output pdf/thesis.pdf
echo "Finished merging"

echo "Done"
